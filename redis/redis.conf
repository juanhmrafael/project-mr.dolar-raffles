# redis.conf para PRODUCCIÓN - Django + Celery (Auditado y Verificado - Julio 2025)
# ====================================================================================================
# Propósito: Este manifiesto define la configuración estática y segura para una instancia de
# Redis 7+ operando como broker de Celery y caché de Django en un entorno Docker.
# Las directivas han sido explícitamente seleccionadas para garantizar seguridad, durabilidad
# y rendimiento, omitiendo configuraciones redundantes o prematuras.
# ====================================================================================================


# --- BLOQUE 1: RED Y SEGURIDAD FUNDAMENTAL ---
# Propósito: Endurecer la superficie de ataque de la red.
# Fuente Canónica: https://redis.io/docs/latest/operate/security/
# ----------------------------------------------------------------------------------------------------

# Directiva: bind 127.0.0.1 ::1
# Justificación: Restringe a Redis para que escuche únicamente en la interfaz de red de loopback
# dentro del contenedor. Esto es una práctica de seguridad crítica que previene la exposición
# accidental del servicio fuera de la red interna de Docker.
bind 127.0.0.1 ::1

# Directiva: protected-mode yes
# Justificación: Esta es una capa de seguridad adicional. Cuando está activado (valor por defecto),
# Redis solo responderá a clientes de las interfaces definidas en 'bind' si no se ha configurado
# autenticación. Lo mantenemos explícitamente para mayor claridad y seguridad.
protected-mode yes

# Directiva: tcp-keepalive 300
# Justificación: Define el intervalo (en segundos) para el envío de sondeos TCP ACK para
# detectar clientes inactivos o conexiones muertas. El valor de 300 segundos (5 minutos)
# es un estándar sensato para limpiar conexiones rotas sin ser demasiado agresivo.
tcp-keepalive 300


# --- BLOQUE 2: PERSISTENCIA Y DURABILIDAD DE DATOS ---
# Propósito: Garantizar que los datos (tareas de Celery, sesiones, caché) no se pierdan
# de forma catastrófica en caso de un reinicio o fallo.
# Fuente Canónica: https://redis.io/docs/latest/operate/oss/persistence/
# ----------------------------------------------------------------------------------------------------

# Directiva: appendonly yes
# Justificación: Habilita el modo "Append Only File" (AOF). Este es el mecanismo de persistencia
# más duradero. Cada operación de escritura se registra en un log. Es superior a la persistencia
# por snapshots (RDB) para casos de uso transaccionales como Celery.
appendonly yes

# Directiva: appendfsync everysec
# Justificación: Controla la frecuencia con la que el log AOF se sincroniza con el disco.
# 'everysec' es el balance perfecto entre rendimiento (solo una operación de escritura a disco por
# segundo) y durabilidad (en el peor de los casos, se pierde como máximo 1 segundo de escrituras).
appendfsync everysec

# Directiva: save ""
# Justificación: Deshabilita por completo la persistencia por snapshots RDB automáticos.
# Cuando se usa AOF, los snapshots periódicos son redundantes, añaden complejidad y pueden
# causar picos de latencia. La optimización de reinicios se gestiona internamente
# mediante el preámbulo RDB del archivo AOF, haciendo esta directiva segura y eficiente.
save ""


# --- BLOQUE 3: GESTIÓN DE RECURSOS Y MEMORIA ---
# Propósito: Proteger el servidor anfitrión de un consumo de memoria descontrolado por parte de Redis.
# Fuente Canónica: https://redis.io/docs/latest/operate/oss/management/eviction/
# ----------------------------------------------------------------------------------------------------

# Directiva: maxmemory 400mb
# Justificación: ¡CRÍTICA! Establece un límite estricto a la memoria que Redis puede utilizar.
# Este valor debe ser ligeramente inferior al límite asignado al contenedor en 'docker-compose.yml'
# (ej., 400MB aquí para un límite de 512MB en Compose) para dejar margen al overhead.
# Previene que Redis agote la memoria del host y cause una caída de todos los servicios.
maxmemory 400mb

# Directiva: maxmemory-policy allkeys-lru
# Justificación: Define la estrategia a seguir cuando se alcanza 'maxmemory'. 'allkeys-lru'
# (Least Recently Used) desaloja las claves que no se han accedido recientemente. Es la política
# ideal para cachés y colas de tareas, ya que preserva los datos más relevantes.
maxmemory-policy allkeys-lru


# --- BLOQUE 4: LOGGING Y DIAGNÓSTICO ---
# Propósito: Configurar cómo Redis reporta su estado operativo.
# ----------------------------------------------------------------------------------------------------

# Directiva: loglevel notice
# Justificación: Establece el nivel de verbosidad de los logs. 'notice' es el estándar para
# producción, registrando eventos importantes sin generar un ruido excesivo.
loglevel notice

# Directiva: logfile ""
# Justificación: Una cadena vacía instruye a Redis para que envíe sus logs a la salida estándar
# (stdout). Esta es la práctica canónica en contenedores, ya que permite que el motor de Docker
# gestione los logs de forma centralizada a través del comando `docker logs`.
logfile ""


# --- BLOQUE 5: CONFIGURACIONES ESPECIALES DE APLICACIÓN ---
# Propósito: Habilitar funcionalidades específicas requeridas por Django y Celery.
# ----------------------------------------------------------------------------------------------------

# Directiva: notify-keyspace-events "Ex"
# Justificación: Habilita la notificación de eventos para claves expiradas ('E') y desalojadas ('x').
# Esto puede ser utilizado por algunas implementaciones de caché de Django o librerías
# relacionadas para reaccionar cuando una clave es eliminada automáticamente.
notify-keyspace-events "Ex"


# --- FIN DEL MANIFIESTO DE CONFIGURACIÓN ---
#
# Nota sobre Omisiones Deliberadas:
# ---------------------------------
# - Autenticación (requirepass, ACLs): Se gestiona dinámicamente en 'docker-compose.yml'
#   para una máxima seguridad y flexibilidad, manteniendo los secretos fuera de este archivo.
# - Ajustes de bajo nivel (ziplist, etc.): Se omiten para evitar la optimización prematura.
#   Los valores por defecto de Redis 7 están altamente optimizados.
# - RDB y Persistencia Híbrida: Se omiten en favor de una configuración AOF pura y simple,
#   que es más robusta y menos compleja para este caso de uso.
#
# Este archivo representa una configuración de producción 'suficiente y necesaria'.
#====================================================================================================