# SECCIÓN A MODIFICAR
# ===================================================================
# DockerGuard v4.0 - Archivo de Configuración de Redis Endurecido con ACL
# Fuente Canónica de ACLs: https://redis.io/docs/management/security/acl/
# Propósito: Única fuente de verdad para la configuración de Redis.
# ===================================================================

# --- Configuración de Red ---
bind 0.0.0.0
protected-mode yes
port 6379

# --- Listado de Control de Acceso (ACL) ---
# Directiva de Seguridad: Se deshabilita el usuario 'default' para reducir la superficie de ataque.
user default off

# Se define explícitamente el usuario de la aplicación ('appuser') con acceso a todas las llaves (~*)
# y todos los comandos (+@all). Su contraseña es un placeholder que será reemplazado al iniciar el contenedor.
user appuser on >PASSWORD_PLACEHOLDER ~* +@all

# --- Persistencia ---
dir /data
appendonly yes

# --- Logging ---
# Se loguea a la salida estándar para ser capturado por Docker.
logfile ""

# SECCIÓN SUSTITUIDA
# ================================================================================================
# DockerGuard v4.1 - Configuración de Redis de Producción (Optimizada y Endurecida)
# Fuente Canónica de Conceptos: Documentación oficial de Redis (redis.io/docs)
# Propósito: Única fuente de verdad para la configuración de Redis, optimizada para rendimiento y resiliencia.
# ================================================================================================

# --- CONFIGURACIÓN DE RED Y CONEXIONES ---
# Escucha en todas las interfaces de red dentro del contenedor, necesario para la comunicación
# entre contenedores en la red de Docker.
bind 0.0.0.0
port 6379

# Directiva de Seguridad: Habilita el modo protegido. Dado que Redis está expuesto en 0.0.0.0,
# esta directiva rechaza conexiones de clientes que no vengan de localhost si no hay una
# contraseña configurada. Al usar ACLs, estamos protegidos, pero se mantiene como defensa en profundidad.
protected-mode yes

# Directiva de Resiliencia: Envía paquetes TCP ACK a los clientes inactivos cada 300 segundos.
# Previene que firewalls intermedios o balanceadores de carga cierren conexiones que consideran
# inactivas, mejorando la estabilidad de las conexiones de larga duración (ej. workers de Celery).
tcp-keepalive 300

# --- GESTIÓN DE MEMORIA (CRÍTICO PARA PRODUCCIÓN) ---
# Directiva de Estabilidad: Establece un límite máximo de memoria que Redis puede usar.
# Este valor DEBE ser inferior al límite de memoria del contenedor definido en docker-compose.yml (512M).
# 400mb es un valor seguro que deja un colchón para el overhead del SO y la fragmentación.
# Previene que Redis consuma toda la memoria del sistema y sea terminado por el OOM killer.
maxmemory 400mb

# Directiva de Rendimiento: Define qué hacer cuando se alcanza `maxmemory`.
# 'allkeys-lru' desaloja las claves menos usadas recientemente de entre todas las claves.
# Es una política excelente y de propósito general para cachés y backends de Celery.
maxmemory-policy allkeys-lru

# --- PERSISTENCIA DE DATOS (ESTRATEGIA AOF-ONLY) ---
# Directorio donde se almacenan los archivos de persistencia, mapeado al volumen de Docker.
dir /data

# Directiva de Durabilidad: Habilita el modo Append-Only File (AOF). Cada comando de escritura
# se añade a un archivo, ofreciendo una mayor durabilidad que la persistencia RDB (snapshot).
appendonly yes

# Directiva de Balance Rendimiento/Durabilidad: Define con qué frecuencia se sincroniza el AOF al disco.
# 'everysec' sincroniza cada segundo. Es el compromiso recomendado, ofreciendo un gran rendimiento
# con un riesgo de pérdida de datos máximo de 1 segundo en caso de un fallo de alimentación.
appendfsync everysec

# Directiva de Optimización: Deshabilita la persistencia RDB (snapshots). Al usar AOF,
# deshabilitar RDB evita la latencia y el consumo de CPU asociados al proceso de forking que
# realiza BGSAVE. Esto conduce a un rendimiento más predecible.
save ""

# --- LOGGING Y OBSERVABILIDAD ---
# Define el nivel de verbosidad del log. 'notice' (default) es adecuado para producción,
# registrando eventos moderadamente importantes. Otros niveles: debug, verbose, warning.
loglevel notice

# Loguea a la salida estándar para que los logs sean gestionados por el driver de logging de Docker.
logfile ""

# --- NOTIFICACIONES DEL KEYSPACE ---
# Habilita la publicación de eventos de expiración ('Ex'). Cuando una clave con TTL expira,
# Redis publicará una notificación. Es requerido por algunas librerías avanzadas o para
# implementar lógicas reactivas en la aplicación. No tiene un gran impacto en el rendimiento.
notify-keyspace-events "Ex"

# --- LISTADO DE CONTROL DE ACCESO (ACL) ---
# Directiva de Seguridad: Deshabilita el usuario 'default'. Principio de privilegios mínimos.
user default off

# Define nuestro usuario de aplicación 'appuser'.
# 'on': Habilita el usuario.
# '>PASSWORD_PLACEHOLDER': Asigna la contraseña (será inyectada por el script de inicio).
# '~*': Le da acceso a todas las claves (keyspace).
# '+@all': Le permite ejecutar todos los comandos.
user appuser on >PASSWORD_PLACEHOLDER ~* +@all