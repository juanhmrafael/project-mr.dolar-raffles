# Configuración de Nginx para PRODUCCIÓN con SSL/TLS End-to-End CORREGIDA
# ====================================================================================================
# Propósito: Configuración endurecida ('hardened') y optimizada para producción,
# implementando cifrado de extremo a extremo con Cloudflare y redirección a HTTPS.
# ====================================================================================================

# --- Bloque Upstream: El Directorio de Servicios Backend ---
upstream django_api {
    server backend:8000;
}

# --- Bloque del Servidor HTTP (Puerto 80): Redirección Permanente a HTTPS ---
server {
    listen 80;
    server_name ganaconsandra.com www.ganaconsandra.com;
    
    # Redirección 301 a HTTPS
    return 301 https://$host$request_uri;
}

# --- Bloque del Servidor HTTPS (Puerto 443): Lógica Principal de la Aplicación ---
server {
    listen 443 ssl http2;
    server_name ganaconsandra.com www.ganaconsandra.com;

    # --- Configuración de SSL/TLS (CORREGIDA) ---
    # CAMBIO CRÍTICO: ssl_private_key → ssl_certificate_key
    ssl_certificate     /etc/nginx/certs/cert.pem;
    ssl_certificate_key /etc/nginx/certs/key.pem;

    # --- Configuración de Protocolos y Cifrados Modernos (2025) ---
    # Protocolos seguros actualizados - solo TLS 1.2 y 1.3
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # Suite de cifrado moderna optimizada para 2025
    # Prioriza TLS 1.3 y cifrados con Perfect Forward Secrecy
    ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305';
    
    # Configuraciones SSL optimizadas
    ssl_prefer_server_ciphers off;  # TLS 1.3 prefiere que el cliente elija
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;  # Mejora la seguridad deshabilitando tickets

    # --- Configuración de Tamaño de Cuerpo ---
    client_max_body_size 20M;

    # --- Cabeceras de Seguridad Avanzadas (Actualizadas 2025) ---
    server_tokens off;
    
    # Cabeceras de seguridad fundamentales
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Cabeceras de seguridad modernas
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Permissions Policy actualizada (reemplaza Feature-Policy)
    add_header Permissions-Policy "accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=()" always;
    
    # HSTS con configuración robusta para producción
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    
    # Content Security Policy básica - personalizar según necesidades
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; media-src 'self'; object-src 'none'; child-src 'self'; frame-ancestors 'self'; base-uri 'self'; form-action 'self';" always;

    # --- Bloques Location: Sistema de Enrutamiento Interno ---
    # Archivos estáticos con caché agresivo
    location /static/ {
        access_log off;
        alias /home/appuser/app/staticfiles/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # Compresión específica para estáticos
        gzip_static on;
    }

    # Archivos de medios con caché moderado
    location /media/ {
        access_log off;
        alias /home/appuser/app/mediafiles/;
        expires 30d;
        add_header Cache-Control "public";
    }

    # Rutas de API y administración
    location ~ ^/(admin-mr\.dolar-ganaconsandra|audit-admin-mr\.dolar-ganaconsandra|api|payments)/  {
        proxy_pass http://django_api;
        
        # Cabeceras de proxy optimizadas
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Configuraciones de timeout optimizadas
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        proxy_redirect off;
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    # Aplicación frontend (SPA)
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # Caché para HTML
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }

    # --- Configuración de Compresión Optimizada ---
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_http_version 1.1;
    gzip_min_length 256;
    gzip_types
        application/atom+xml
        application/geo+json
        application/javascript
        application/x-javascript
        application/json
        application/ld+json
        application/manifest+json
        application/rdf+xml
        application/rss+xml
        application/xhtml+xml
        application/xml
        font/eot
        font/otf
        font/ttf
        image/svg+xml
        text/css
        text/javascript
        text/plain
        text/xml;

    # Configuración Brotli (si está disponible)
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types text/xml image/svg+xml application/x-font-ttf image/vnd.microsoft.icon application/x-font-opentype application/json font/eot application/vnd.ms-fontobject application/javascript font/otf application/xml application/xhtml+xml text/javascript  application/x-javascript text/plain application/xml+rss text/css;

    # --- Configuración de Rate Limiting (Opcional) ---
    # limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    # location /api/ {
    #     limit_req zone=api burst=20 nodelay;
    # }
}