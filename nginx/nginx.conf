# /nginx/nginx.conf
# ====================================================================================================
# Propósito: Archivo de configuración principal y global para Nginx.
# Este archivo establece las directivas de rendimiento y seguridad a nivel de servidor
# y proporciona el contexto 'http' correcto para incluir las configuraciones de sitio.
# ====================================================================================================

# Define con qué usuario se ejecutarán los procesos de Nginx.
# 'nginx' es el usuario estándar creado por la instalación del paquete en Alpine Linux.
user nginx;

# Define cuántos procesos de trabajo se lanzarán.
# 'auto' es la mejor práctica canónica, ya que instruye a Nginx para que se ajuste
# automáticamente al número de núcleos de CPU disponibles en el servidor host.
worker_processes auto;

# Define la ruta del archivo de log de errores y el archivo de Process ID (PID).
# Loguearemos las advertencias y errores para mantener la observabilidad.
error_log /var/log/nginx/error.log warn;
pid       /var/run/nginx.pid;


# --- Bloque de Configuración de Eventos de Red ---
events {
    # Define el número máximo de conexiones simultáneas que cada proceso de trabajo puede manejar.
    # 1024 es un punto de partida seguro y estándar.
    worker_connections 1024;
}


# --- Bloque de Configuración de Tráfico HTTP ---
# Este es el bloque de contexto más importante. Todo el tráfico web es manejado aquí.
http {
    # Incluye el archivo que mapea las extensiones de archivo a los tipos MIME.
    # Esencial para que el navegador sepa cómo interpretar cada archivo (ej. .css es text/css).
    include       /etc/nginx/mime.types;
    # Define un tipo por defecto si la extensión no es reconocida, previniendo errores.
    default_type  application/octet-stream;

    # Define el formato de log de acceso. Incluimos cabeceras importantes como
    # X-Forwarded-For para ver la IP real del cliente detrás del proxy.
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    # Activa y define la ruta para el log de acceso.
    access_log  /var/log/nginx/access.log  main;

    # --- Directivas de Optimización de Rendimiento ---
    # Permite a Nginx usar la llamada al sistema 'sendfile()' del kernel, que es una forma
    # extremadamente eficiente de copiar datos desde un archivo al socket de red.
    sendfile        on;

    # Optimiza el envío de paquetes de red.
    tcp_nopush      on;
    tcp_nodelay     on;

    # Tiempo que una conexión 'keep-alive' permanecerá abierta.
    keepalive_timeout  65;
    
    # Aumenta el tamaño de las tablas hash para los tipos MIME, previniendo errores en sistemas
    # con muchos tipos de contenido.
    types_hash_max_size 2048;


    # =========================================================================
    # INSTRUCCIÓN CRÍTICA: La Inclusión de la Configuración del Sitio
    # =========================================================================
    # Esta línea le dice a Nginx que cargue TODOS los archivos que terminen en .conf
    # desde el directorio /etc/nginx/conf.d/.
    # Al estar DENTRO del bloque 'http', asegura que su archivo 'default.conf'
    # sea leído en el contexto correcto, permitiendo el uso de la directiva 'upstream'
    # y resolviendo el error fatal.
    include /etc/nginx/conf.d/*.conf;
    # =========================================================================
}